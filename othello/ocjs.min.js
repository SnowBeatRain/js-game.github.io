"use strict";
/**********************
 *  程序：黑白棋人机博弈
 *  作者：jslang(海浪)
 *  版本：1.0
 *  日期：2015年7月1日
 **********************/

function Chessboard(){function e(c){for(var d=0;64>d;d++)!function(d){c[d].onclick=function(){"prompt"==b[d].className&&a.toDown(d)}}(d);c=void 0}var b,c,d,a=this;a.toDown=null,a.create=function(){var g,h,a=document.getElementById("chessboard"),f="<table>";for(g=0;8>g;g++){for(f+="<tr>",h=0;8>h;h++)f+="<td class='bg"+(h+g)%2+"'><div></div></td>";f+="</tr>"}f+="</table>",a.innerHTML=f,b=a.getElementsByTagName("div"),e(a.getElementsByTagName("td")),c=document.getElementById("left").getElementsByTagName("span"),d={1:document.getElementById("side1"),"-1":document.getElementById("side2")}},a.update=function(a,e){var f,g;for(f=0;64>f;f++)b[f].className=["white","","black"][a[f]+1];if(!e)for(g in a.next)b[g].className="prompt";for(f=0;f<a.newRev.length;f++)b[a.newRev[f]].className+=" reversal";-1!=a.newPos&&(b[a.newPos].className+=" newest"),c[0].innerHTML=a.black,c[1].innerHTML=a.white,d[a.side].className="cbox side",d[-a.side].className="cbox"}}function AI(){function i(a){return a>0?1:0>a?-1:0}function j(a){var h,g,i,j,k,l,m,n,o,p,q,r,b=0,c=0,f={};for(g=0,i=e.length;h=e[g],i>g;g++)if(0!=a[h.s]){for(b+=15*a[h.s],c+=a[h.s],j=0;2>j;j++)if(!f[h.s+h.dr[j]]){for(k=!0,l=0,m=1;6>=m&&(n=a[h.s+h.dr[j]*m],0!=n);m++)k&&n==a[h.s]?c+=n:(k=!1,l+=n);7==m&&0!=a[h.s+7*h.dr[j]]&&(c+=l,f[h.s+6*h.dr[j]]=!0)}}else b+=-3*a[h.a],b+=-3*a[h.b],b+=-6*a[h.c];for(o=0,g=9;54>=g;g+=6==(7&g)?3:1)if(0!=a[g])for(m=0;8>m;m++)if(0==a[othe.dire(g,m)]){o-=a[g];break}return p=(a.nextNum-a.prevNum)*a.side,q=a.space<18?0==a.space%2?-a.side:a.side:0,r=b*d[0]+c*d[1]+o*d[2]+p*d[3]+q*d[4],r*a.side}function k(a){var c=a.black-a.white;return b>=15?1e4*i(c)*a.side:1e4*(c+a.space*i(c))*a.side}function l(a,b,c){var f,d=-1/0,e=1/0;do f=c==d?c+1:c,c=m(a,b,f-1,f),f>c?e=c:d=c;while(e>d);return f>c&&(c=m(a,b,c-1,c)),c}function m(b,d,e,f){var g,i,l,p,q,r,s,t,u,v;if((new Date).getTime()>c)throw new Error("time out");if(g=h.get(b.key,d,e,f),g!==!1)return g;if(0==b.space)return k(b);if(othe.findLocation(b),0==b.nextNum)return 0==b.prevNum?k(b):(othe.pass(b),-m(b,d,-f,-e));if(0>=d)return i=j(b),h.set(b.key,i,d,0,null),i;for(l=h.getBest(b.key),null!==l&&n(b.nextIndex,l),p=a.history[1==b.side?0:1][b.space],q=1,r=-1/0,s=null,t=0;t<b.nextNum;t++)if(u=b.nextIndex[t],v=-m(othe.newMap(b,u),d-1,-f,-e),v>r&&(r=v,s=u,v>e&&(e=v,q=0,o(p,u)),v>=f)){q=2;break}return n(p,s),h.set(b.key,r,d,q,s),r}function n(a,b){if(a[0]!=b){var c=a.indexOf(b);a.splice(c,1),a.unshift(b)}}function o(a,b){if(a[0]!=b){var c=a.indexOf(b);a[c]=a[c-1],a[c-1]=b}}var b,c,d,e,f,g,h,a=this;for(a.calculateTime=1e3,a.outcomeDepth=16,d=[6,11,2,2,3],e=[{s:0,a:1,b:8,c:9,dr:[1,8]},{s:7,a:6,b:15,c:14,dr:[-1,8]},{s:56,a:57,b:48,c:49,dr:[1,-8]},{s:63,a:62,b:55,c:54,dr:[-1,-8]}],a.history=[[],[]],f=0;2>f;f++)for(g=0;60>=g;g++)a.history[f][g]=[0,63,7,56,37,26,20,43,19,29,34,44,21,42,45,18,2,61,23,40,5,58,47,16,10,53,22,41,13,46,17,50,51,52,12,11,30,38,25,33,4,3,59,60,39,31,24,32,1,62,15,48,8,55,6,57,9,54,14,49];h=new Transposition,a.startSearch=function(d){var f,e=0;if(d.space<=a.outcomeDepth)return c=(new Date).getTime()+6e5,b=d.space,e=l(d,b,e),h.getBest(d.key);c=(new Date).getTime()+a.calculateTime,b=0;try{for(;b<d.space;)e=l(d,++b,e),f=h.getBest(d.key)}catch(g){if("time out"!=g.message)throw g}return f}}function Transposition(){var a=this,b=524287,c=new Array(b+1);a.set=function(a,d,e,f,g){var h=a[0]&b,i=c[h];if(i){if(i.key==a[1]&&i.depth>e)return}else i=c[h]={};i.key=a[1],i.eva=d,i.depth=e,i.flags=f,i.best=g},a.get=function(a,d,e,f){var g=c[a[0]&b];if(!g||g.key!=a[1]||g.depth<d)return!1;switch(g.flags){case 0:return g.eva;case 1:return g.eva<=e?g.eva:!1;case 2:return g.eva>=f?g.eva:!1}},a.getBest=function(a){var d=c[a[0]&b];return d&&d.key==a[1]?d.best:null}}function Zobrist(){function e(){return 4294967296*Math.random()>>0}var d,a=this,b=[e(),e()],c=[[],[],[]];for(d=0;64>d;d++)c[0][d]=[e(),e()],c[1][d]=[e(),e()],c[2][d]=[c[0][d][0]^c[1][d][0],c[0][d][1]^c[1][d][1]];a.swap=function(a){a[0]^=b[0],a[1]^=b[1]},a.set=function(a,b,d){a[0]^=c[b][d][0],a[1]^=c[b][d][1]}}function Othello(){function f(){var c=a.aiSide==b.side||2==a.aiSide;return a.findLocation(b),board.update(b,c),0==b.space||0==b.nextNum&&0==b.prevNum?(h(),void 0):0==b.nextNum?(a.pass(b),setTimeout(f,200),void 0):(c&&(d=!0,setTimeout(g,20)),void 0)}function g(){1==b.nextNum?a.go(b.nextIndex[0]):b.space<=58?a.go(ai.startSearch(b)):a.go(b.nextIndex[Math.random()*b.nextIndex.length>>0])}function h(){alert("棋局结束\n\n黑棋: "+b.black+" 子\n白棋: "+b.white+" 子\n\n"+(b.black==b.white?"平局!!!":b.black>b.white?"黑棋胜利!!!":"白棋胜利!!!"))}var a=this,b=[],c=[],d=!1,e=new Zobrist;a.aiSide=-1,a.play=function(){var a,e;if(!d){for(b=[],a=0;64>a;a++)b[a]=0;for(b[28]=b[35]=1,b[27]=b[36]=-1,b.black=b.white=2,b.space=60,b.frontier=[],e=[18,19,20,21,26,29,34,37,42,43,44,45],a=0;12>a;a++)b.frontier[e[a]]=!0;b.side=1,b.newPos=-1,b.newRev=[],b.nextIndex=[],b.next={},b.nextNum=0,b.prevNum=0,b.key=[0,0],c=[],f()}},a.dire=function(){var a=[-8,-7,1,9,8,7,-1,-9],b=[8,0,0,0,8,7,7,7];return function(c,d){return c+=a[d],0!=(64&c)||(7&c)==b[d]?64:c}}(),a.findLocation=function(b){function c(c,d){for(var e=0;64!=(c=a.dire(c,d))&&b[c]==-b.side;)g[h++]=c,e++;(64==c||b[c]!=b.side)&&(h-=e)}var d,e,f,g,h,i;for(b.nextIndex=[],b.next=[],d=ai.history[1==b.side?0:1][b.space],e=0;60>e;e++)if(f=d[e],b.frontier[f]){for(g=[],h=0,i=0;8>i;i++)c(f,i);h>0&&(h!=g.length&&(g=g.slice(0,h)),b.next[f]=g,b.nextIndex.push(f))}b.nextNum=b.nextIndex.length},a.pass=function(a){a.side=-a.side,a.prevNum=a.nextNum,e.swap(a.key)},a.newMap=function(b,c){var f,g,h,i,d=b.slice(0);for(d[c]=b.side,d.key=b.key.slice(0),e.set(d.key,1==b.side?0:1,c),d.frontier=b.frontier.slice(0),d.frontier[c]=!1,f=0;8>f;f++)g=a.dire(c,f),64!=g&&0==d[g]&&(d.frontier[g]=!0);for(h=b.next[c],i=h.length,f=0;i>f;f++)d[h[f]]=b.side,e.set(d.key,2,h[f]);return 1==b.side?(d.black=b.black+i+1,d.white=b.white-i):(d.white=b.white+i+1,d.black=b.black-i),d.space=64-d.black-d.white,d.side=-b.side,d.prevNum=b.nextNum,e.swap(d.key),d},a.goChess=function(d){c.push(b),a.go(d)},a.go=function(c){d=!1;var e=b.next[c];b=a.newMap(b,c),b.newRev=e,b.newPos=c,f()},a.historyBack=function(){d||0==c.length||(b=c.pop(),f())}}var board=new Chessboard,ai=new AI,othe=new Othello;board.create(),board.toDown=othe.goChess,document.getElementById("play").onclick=function(){document.getElementById("selectbox").style.display="block"},document.getElementById("back").onclick=function(){othe.historyBack()},document.getElementById("ok").onclick=function(){var a,b;for(document.getElementById("selectbox").style.display="none",a=document.getElementById("selectbox").getElementsByTagName("input"),othe.aiSide=a[0].checked?-1:1,b=2;b<a.length&&!a[b].checked;b++);ai.calculateTime=[50,200,1e3,4e3,1e4,2e4][b-2],ai.outcomeDepth=[8,10,14,15,16,16][b-2],othe.play()},document.getElementById("cancel").onclick=function(){document.getElementById("selectbox").style.display="none"};
